<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio WebSocket Stream</title>
</head>
<body>
    <h1>Audio Streaming to WebSocket</h1>
    <button id="startButton">Start Streaming</button>
    <p id="status">Status: Not Connected</p>

    <script>
        async function captureAudio() {
            try {
                return await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.error('Error capturing audio:', err);
                document.getElementById("status").innerText = "Status: Error capturing audio";
            }
        }

        function sendAudioToWebSocket(ws, stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const mediaStreamSource = audioContext.createMediaStreamSource(stream);
            const sampleRate = audioContext.sampleRate;
            const bufferSize = 4096; // Smaller buffer size, to be aggregated
            const targetDuration = 0.5; // 0.5 seconds
            const targetBufferLength = sampleRate * targetDuration;
            let accumulatedBuffer = new Float32Array(0);

            const scriptProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            scriptProcessor.onaudioprocess = function(audioProcessingEvent) {
                const inputBuffer = audioProcessingEvent.inputBuffer;
                const inputData = inputBuffer.getChannelData(0); // get audio data as Float32Array

                // Accumulate buffers
                let newBuffer = new Float32Array(accumulatedBuffer.length + inputData.length);
                newBuffer.set(accumulatedBuffer, 0);
                newBuffer.set(inputData, accumulatedBuffer.length);
                accumulatedBuffer = newBuffer;

                // If the accumulated buffer is at least 0.5 seconds, send it
                if (accumulatedBuffer.length >= targetBufferLength) {
                    const dataToSend = accumulatedBuffer.subarray(0, targetBufferLength);
                    const encodedData = encodeAudio(dataToSend);
                    ws.send(encodedData); // send encoded data via WebSocket

                    // Remove the sent data from the accumulated buffer
                    accumulatedBuffer = accumulatedBuffer.subarray(targetBufferLength);
                }
            };

            mediaStreamSource.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
        }

        function encodeAudio(buffer) {
            // Convert Float32Array to Uint8Array for Base64 encoding
            const byteArray = new Uint8Array(buffer.buffer);

            // Convert the Uint8Array to a binary string
            let binaryString = '';
            for (let i = 0; i < byteArray.length; i++) {
                binaryString += String.fromCharCode(byteArray[i]);
            }

            // Encode the binary string to Base64
            return btoa(binaryString);
        }

        async function startStreamingAudioToWebSocket(host, port) {
            const ws = new WebSocket(`ws://${host}:${port}`);

            ws.onopen = async function() {
                console.log('WebSocket connection established');
                document.getElementById("status").innerText = "Status: Connected";
                const stream = await captureAudio();
                if (stream) {
                    sendAudioToWebSocket(ws, stream);
                }
            };

            ws.onmessage = function(event) {
                console.log('Received message:', event.data);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                document.getElementById("status").innerText = "Status: Disconnected";
            };
        }

        document.getElementById("startButton").onclick = function() {
            startStreamingAudioToWebSocket('localhost', 7007); // Adjust host and port as needed
        };
    </script>
</body>
</html>
