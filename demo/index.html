<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio WebSocket Stream</title>
</head>
<body>
    <h1>Audio Streaming to WebSocket</h1>
    <button id="startButton">Start Streaming</button>
    <p id="status">Status: Not Connected</p>

    <script>
        async function captureAudio() {
            try {
                return await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.error('Error capturing audio:', err);
                document.getElementById("status").innerText = "Status: Error capturing audio";
            }
        }

        async function sendAudioToWebSocket(ws, stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // Load the audio worklet processor
            await audioContext.audioWorklet.addModule('pcm-processor.js');

            // Create an instance of AudioWorkletNode
            const pcmNode = new AudioWorkletNode(audioContext, 'pcm-processor');

            // Handle messages received from the worklet processor
            pcmNode.port.onmessage = (event) => {
                const rawPCMData = event.data;
                const encodedData = encodeAudio(rawPCMData);
                ws.send(encodedData); // Send encoded data via WebSocket
            };

            const mediaStreamSource = audioContext.createMediaStreamSource(stream);
            mediaStreamSource.connect(pcmNode);
            pcmNode.connect(audioContext.destination);
        }

        function encodeAudio(buffer) {
            // Convert Float32Array to Uint8Array for Base64 encoding
            const byteArray = new Uint8Array(buffer.buffer);

            // Convert the Uint8Array to a binary string
            let binaryString = '';
            for (let i = 0; i < byteArray.length; i++) {
                binaryString += String.fromCharCode(byteArray[i]);
            }

            // Encode the binary string to Base64
            return btoa(binaryString);
        }

        async function startStreamingAudioToWebSocket(host, port) {
            const ws = new WebSocket(`ws://${host}:${port}`);

            ws.onopen = async function() {
                console.log('WebSocket connection established');
                document.getElementById("status").innerText = "Status: Connected";
                const stream = await captureAudio();
                if (stream) {
                    sendAudioToWebSocket(ws, stream);
                }
            };

            ws.onmessage = function(event) {
                console.log('Received message:', event.data);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                document.getElementById("status").innerText = "Status: Disconnected";
            };
        }

        document.getElementById("startButton").onclick = function() {
            startStreamingAudioToWebSocket('localhost', 7007); // Adjust host and port as needed
        };
    </script>
</body>
</html>
